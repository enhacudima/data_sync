<template>
  <v-card  outlined>
      <v-card-text>
          <v-form ref="loginForm" v-model="valid" lazy-validation>
              <v-row>
                  <v-col cols="12">
                      <v-text-field v-model="loginEmail" :rules="loginEmailRules" label="E-mail" required :error-messages="loginError"></v-text-field>
                  </v-col>
                  <v-col class="d-flex" cols="12" sm="12" xsm="12" align-end>
                      <v-btn elevation="1" large block  color="#e1b80d" @click="validate"> {{$t('send_link')}} </v-btn>
                  </v-col>
              </v-row>
          </v-form>
      </v-card-text>
        <v-divider></v-divider>
        <v-card-actions>
            <v-btn text>
                <div class="locale-changer">
                    <select v-model="$i18n.locale">
                    <option v-for="(lang, i) in langs" :key="`Lang${i}`" :value="lang">
                        {{ lang.replaceAll('_', ' ').toUpperCase()}}
                    </option>
                    </select>
                </div>
            </v-btn>
        <v-spacer></v-spacer>
        <v-btn text
        to="/"
        >
            Cancel
        </v-btn>
        </v-card-actions>

    <v-dialog
      v-model="dialogW"
      hide-overlay
      persistent
      width="300"
    >
      <v-card
        color="primary"
        dark
      >
        <v-card-text>
          Please wait ...
          <v-progress-linear
            indeterminate
            color="white"
            class="mb-0"
          ></v-progress-linear>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-card>
</template>

<script>
export default {
  data() {
    return {
      my_lang:'pt',
      langs: ['en', 'pt'] ,
      dialogW:false,
      loginError:null,
      dialog: true,
      tab: 0,
      tabs: [
          {name:"Login", icon:"mdi-account"},
      ],
      valid: true,
      loginPassword: "",
      loginEmail: "",
      loginEmailRules: [
        v => !!v || "Required",
        v => /.+@.+\..+/.test(v) || "E-mail must be valid"
      ],
      show1: false,
      rules: {
        required: value => !!value || "Required.",
        min: v => (v && v.length >= 8) || "Min 8 characters"
      },
      testError:'',
      country:'',
      user_id:'',
      verMessage:'',
      verUrl:'',
      allerros:'',
      sucess:'',
      verDescription: '',
      verButtonMessage: '',
    };
  },
  beforeCreate() {
    this.form = this.$form.createForm(this, { name: 'normal_login' });
  },
  methods: {
    validate() {
      if (this.$refs.loginForm.validate()) {
        // submit form to server/API here...
        this.dialogW=true;
        this.login(this.loginEmail,this.loginPassword);
      }
    },
    reset() {
      this.$refs.form.reset();
    },
    resetValidation() {
      this.$refs.form.resetValidation();
    },

    login (email) {
      axios
      .post("forgot-password", {  email: email})
        .then(response => {
            this.dialogW=false;
            this.allerros = [];
            this.sucess = true;
            if (response.data.errors) {
                //console.log(response.data.errors);
                this.loginError=errors[0];
                //response.data.errors.forEach(error => { this.openNotification('error', 'Error on Save', error);});


            } else {
            //console.log(response.data.message);
            this.dialogW=false;
            this.openNotification('info', 'Reset', response.data.message);
            this.$router.push({ name: 'ForgotPasswordResult' })

            }
        })
        .catch((error) => {
            this.dialogW=false;
            this.success = false;
            var errors =null;
            var status=error.response.status;
            //console.log(status);
                if (status == 422){
                errors=error.response.data.errors;
                //console.log(errors);
                this.loginError=errors[0];
                //errors.forEach(error => { this.openNotification('error', 'Error on Save', error);});
            }else{
                this.openNotification('error','Error on Save',error);
            }
        });
    },

    openNotification: function (type, m, d) {
        this.$notification.config({
            placement: 'topRight',
            top: 35,
            duration: 8,
        });
        this.$notification[type]({
          message: m,
          description: d,
        });
    },
    closeNotification(key){
        axios
        .post(this.verUrl, { data: { id: this.user_id} })
        .then(response => {
            this.allerros = [];
            this.sucess = true;
            if (response.data.errors) {
                response.data.errors.forEach(error => { this.openNotification('error', 'Action Button Error', error);});

            } else {

                this.openNotification('success', this.verMessage, 'Action Button successfully');
            }
        })
      .catch((error) => {
        this.success = false;
        var errors =null;
        var status=error.response.status;
            if (status == 422){
            errors=error.response.data.errors;
            errors.forEach(error => { this.openNotification('error', 'Action Button Error', error);});
          }else{
            this.openNotification('error','Action Button Error',error.response.data['error']);
          }
      });

        this.$notification.close(key)
    },
    openVerifyNotification() {
      const key = `open${Date.now()}`;
      this.$notification.open({
        message: this.verMessage,
        placement:'bottomRight',
        description:
           this.verDescription,
        btn: h => {
          return h(
            'a-button',
            {
              props: {
                type: 'primary',
                size: 'small',
              },
              on: {
                click: () => this.closeNotification(key),
              },
            },
            this.verButtonMessage,
          );
        },
        key,
        onClose: close,
        duration: 0,

      });
    },

  },
};
</script>
<style>
#components-form-demo-normal-login .login-form {
  max-width: 300px;
}
#components-form-demo-normal-login .login-form-forgot {
  float: right;
}
#components-form-demo-normal-login .login-form-Remember {
  float: left ;
}
#components-form-demo-normal-login .login-form-button {
  width: 100%;
}
</style>
